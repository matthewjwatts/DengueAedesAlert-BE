1.	Real time function (for 2024)
  a.	Mosquito information (colouring a postal code):
    i.	2024 â€“ information on a cumulative basis over 2024
    ii.	Scenarios 2 need to be marked: these are for 2024: Lebbeke, Puurs-Sint-Amands, Wilrijk and Kessel-Lo
  b.	Imported dengue case information (coloured stars):
    i.	Cases of the last week: with the mark of a red star (for example)
    ii.	Cases per month of 2024: to work with a different colour per month and with different size depending on number of cases for that month in that postal code
  c.	Overlap : alert function when a case in the current week is detected in a postal code where the mosquito was detected in 2024



#current_year <- 2023
```{r}

library(tidyverse)
library(leaflet)
library(sf)

# Convert 'Detection_date' to Date format if it's not already
aedes_data <- aedes_data %>%
  mutate(Detection_date = as.Date(Detection_date, format = "%Y-%m-%d")) # Adjust the format as needed

# Assuming 'Detection_date' is in Date format
current_year <- format(Sys.Date(), "%Y")

# Filter the data for the current year
aedes_data_filtered <- aedes_data %>%
  filter(format(Detection_date, "%Y") == current_year)

aedes_data_filtered <- dplyr::select(aedes_data_filtered, Postcode, Municipality)

aedes_data_filtered <-  dplyr::inner_join(postaldistricts, aedes_data_filtered, by = 'Postcode')


# Convert 'Report_date' to Date format if it's not already
dengue_data <- dengue_data %>%
  mutate(Report_date = as.Date(Report_date, format = "%Y-%m-%d"))  # Adjust the format if necessary

# Get the current date
#current_date <- '2023-08-28'

# Assuming 'Detection_date' is in Date format
current_date <- format(Sys.Date(), "%Y-%m-%d")

current_date <- as.Date(current_date, format = "%Y-%m-%d")  # Removed the extra closing parenthesis

# Calculate the date 7, 14, 21, or 28 days before the current date, this should use the slider
start_date <- current_date - 7

# Filter the data to include only the last 7 days
dengue_data_filtered <- dengue_data %>%
  filter(Report_date >= start_date & Report_date <= current_date)

aedes_dengue_matches <-  dplyr::inner_join(aedes_data_filtered,dengue_data_filtered,  by = 'Postcode')

# Ensure the data is in the correct CRS (Coordinate Reference System) for Leaflet
aedes_dengue_matches <- st_transform(aedes_dengue_matches, crs = 4326)  # WGS 84

# Calculate the number of cases per postcode
aedes_dengue_matches_count <- aedes_dengue_matches %>%
  group_by(Postcode, Municipality) %>%
  summarize(case_count = n(), .groups = 'drop')

# Define the bounding box for Belgium manually
belgium_bbox <- list(
  xmin = 2.524,  # Westernmost longitude
  ymin = 49.496, # Southernmost latitude
  xmax = 6.408,  # Easternmost longitude
  ymax = 51.505  # Northernmost latitude
)

# Create the leaflet map
leaflet(data = aedes_dengue_matches_count) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(color = "red", weight = 2, fillOpacity = 0.5, 
              popup = ~paste("Municipality: ", Municipality, "; Post Code: ", Postcode, 
                             "; N.cases: ", case_count)) %>%  # Plot polygons in red
  fitBounds(lng1 = belgium_bbox$xmin, lat1 = belgium_bbox$ymin, 
            lng2 = belgium_bbox$xmax, lat2 = belgium_bbox$ymax)


```


