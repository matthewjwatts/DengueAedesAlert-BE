

1.	Real time function (for 2024)
  a.	Mosquito information (colouring a postal code):
    i.	2024 â€“ information on a cumulative basis over 2024
    ii.	Scenarios 2 need to be marked: these are for 2024: Lebbeke, Puurs-Sint-Amands, Wilrijk and Kessel-Lo
  b.	Imported dengue case information (coloured stars):
    i.	Cases of the last week: with the mark of a red star (for example)
    ii.	Cases per month of 2024: to work with a different colour per month and with different size depending on number of cases for that month in that postal code
  c.	Overlap : alert function when a case in the current week is detected in a postal code where the mosquito was detected in 2024


- Combine data sets one of matches and one of no matches to look at distribution 
- report only matches in dataframe report



```{r}

library(tidyverse)
library(leaflet)
library(sf)

# Convert 'Detection_date' to Date format if it's not already
aedes_data <- aedes_data %>%
  mutate(Detection_date = as.Date(Detection_date, format = "%Y-%m-%d")) # Adjust the format as needed

# Assuming 'Detection_date' is in Date format
#current_year <- format(Sys.Date(), "%Y")

current_year <- 2023

# Filter the data for the current year
aedes_data_filtered <- aedes_data %>%
  filter(format(Detection_date, "%Y") == current_year)

aedes_data_filtered <- dplyr::select(aedes_data_filtered, Postcode, Municipality)

aedes_data_filtered <-  dplyr::inner_join(postaldistricts, aedes_data_filtered, by = 'Postcode')

```


```{r}

# Convert 'Report_date' to Date format if it's not already

dengue_data <- dengue_data %>%
  mutate(Report_date = as.Date(Report_date, format = "%Y-%m-%d"))  # Adjust the format if necessary

# Get the current date
current_date <- '2023-08-28'

# Assuming 'Detection_date' is in Date format
#current_date <- format(Sys.Date(), "%Y-%m-%d")

current_date <- as.Date(current_date, format = "%Y-%m-%d")  # Removed the extra closing parenthesis

# Calculate the date 7, 14, 21, or 28 days before the current date, this should use the slider
start_date <- current_date - 90

# Filter the data to include only the last 7 days
dengue_data_filtered <- dengue_data %>%
  filter(Report_date >= start_date & Report_date <= current_date)

```



```{r}

# create grey red
aedes_dengue_matches <-  dplyr::inner_join(aedes_data_filtered,dengue_data_filtered,  by = 'Postcode')

aedes_dengue_non_matches <-  dplyr::anti_join(aedes_data_filtered,dengue_data_filtered,  by = 'Postcode')

# create grey red
dengue_cases <-  dengue_data_filtered

# Calculate the number of cases per postcode
dengue_case_count <- dengue_cases %>%
  group_by(Postcode) %>%
  summarize(case_count = n(), .groups = 'drop')


dengue_case_count <-  dplyr::inner_join(postaldistricts, dengue_case_count, by = 'Postcode')

# Convert polygon to point using point on surface
dengue_case_count <- st_centroid(dengue_case_count)

# Ensure the data is in the correct CRS (Coordinate Reference System) for Leaflet
aedes_dengue_matches <- st_transform(aedes_dengue_matches, crs = 4326)  # WGS 84

# Calculate the number of cases per postcode
aedes_dengue_matches_count <- aedes_dengue_matches %>%
  group_by(Postcode, Municipality) %>%
  summarize(case_count = n(), .groups = 'drop')

# Define the bounding box for Belgium manually
belgium_bbox <- list(
  xmin = 2.524,  # Westernmost longitude
  ymin = 49.496, # Southernmost latitude
  xmax = 6.408,  # Easternmost longitude
  ymax = 51.505  # Northernmost latitude
)

```

```{r}

custom_icons <- icons(
  iconUrl = "www/icons/68004_location_pin_icon.png",  # Use your image URL
  iconWidth = 10,  # Width of the icon
  iconHeight = 10,  # Height of the icon
)

# Create the leaflet map
leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  
  # Add polygons with matching cases
  addPolygons(data = aedes_dengue_matches_count, 
              color = "red", weight = 2, fillOpacity = 0.5, 
              group = "Matches",   # Add group for legend
              popup = ~paste("Municipality: ", Municipality, "; Post Code: ", Postcode, 
                             "; N.cases: ", case_count)) %>%  # Plot polygons in red
                             
  # Add polygons without matching cases
  addPolygons(data = aedes_dengue_non_matches, 
              color = "grey", weight = 2, fillOpacity = 0.5, 
              group = "No-overlap",   # Add group for legend
              popup = ~paste("Municipality: ", Municipality, "; Post Code: ", Postcode)) %>%  # Plot polygons in grey
  
  # Fit the bounds to your region (Belgium)
  fitBounds(lng1 = belgium_bbox$xmin, lat1 = belgium_bbox$ymin, 
            lng2 = belgium_bbox$xmax, lat2 = belgium_bbox$ymax) %>%
  
  addMarkers(data = dengue_case_count, icon = custom_icons, popup = ~paste("Post Code: ", Postcode, "; N.cases: ", case_count)) %>%

  
  # Add legend to distinguish between the two categories of polygons
  addLegend(position = "bottomright", 
            colors = c("red", "grey"),   # Colors for the legend
            labels = c("Overlap-with Dengue", "No-overlap Dengue"),  # Corresponding labels
            title = "Aedes positive postcodes",
            opacity = 0.5)  %>%

# Add a second custom legend for the marker icons
  addControl(html = "
     <div style='background: white; padding: 10px;'>
       <div style='display: flex; align-items: center;'>
          <img src='icons/68004_location_pin_icon.png' width='25' height='41' style='margin-right: 5px;'> 
         Dengue Cases
       </div>
     </div>", 
     position = "bottomleft")

```


